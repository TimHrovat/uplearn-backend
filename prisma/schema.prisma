generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

model User {
    id String @id @default(uuid())

    name        String
    surname     String
    username    String   @unique
    email       String
    gsm         String?
    dateOfBirth DateTime

    firstPasswordReplaced Boolean @default(false)
    firstPassword         String?
    password              String

    createdAt DateTime @default(now())
    updatedAt DateTime @default(now()) @updatedAt

    role Role

    Employee Employee?
    Student  Student?
}

enum Role {
    employee
    student
    admin
}

model Employee {
    id String @unique @default(uuid())

    user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
    userId String @unique

    Employee_Subject       Employee_Subject[]
    ClassTeacher           Class?             @relation("class-teacher")
    SubstituteClassTeacher Class?             @relation("substitute-class-teacher")

    @@id([id, userId])
}

model Subject {
    abbreviation String  @id
    name         String
    description  String?

    Employee_Subject    Employee_Subject[]
    Subject_SubjectList Subject_SubjectList[]
}

model Employee_Subject {
    employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
    employeeId String

    subject             Subject @relation(fields: [subjectAbbreviation], references: [abbreviation], onDelete: Cascade)
    subjectAbbreviation String

    Employee_Subject_Class Employee_Subject_Class[]
    Lesson                 Lesson[]

    @@id([employeeId, subjectAbbreviation])
}

model SubjectList {
    id   String @id @default(uuid())
    name String

    Subject_SubjectList Subject_SubjectList[]
    Class               Class[]
}

model Subject_SubjectList {
    subject             Subject @relation(fields: [subjectAbbreviation], references: [abbreviation], onDelete: Cascade)
    subjectAbbreviation String

    subjectList   SubjectList @relation(fields: [subjectListId], references: [id], onDelete: Cascade)
    subjectListId String

    @@id([subjectAbbreviation, subjectListId])
}

model Class {
    name String @id
    year Int

    subjectList   SubjectList? @relation(fields: [subjectListId], references: [id], onDelete: Cascade)
    subjectListId String?

    Employee_Subject_Class Employee_Subject_Class[]
    Student                Student[]

    classTeacher   Employee? @relation(name: "class-teacher", fields: [classTeacherId], references: [id], onDelete: Cascade)
    classTeacherId String?   @unique

    substituteClassTeacher   Employee? @relation(name: "substitute-class-teacher", fields: [substituteClassTeacherId], references: [id], onDelete: Cascade)
    substituteClassTeacherId String?   @unique

    Lesson Lesson[]
}

model Employee_Subject_Class {
    employee_Subject    Employee_Subject @relation(fields: [employeeId, subjectAbbreviation], references: [employeeId, subjectAbbreviation], onDelete: Cascade)
    employeeId          String
    subjectAbbreviation String

    class     Class  @relation(fields: [className], references: [name], onDelete: Cascade)
    className String

    @@id([employeeId, subjectAbbreviation, className])
}

model Student {
    id String @unique @default(uuid())

    user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
    userId String @unique

    class     Class?  @relation(fields: [className], references: [name], onDelete: SetNull)
    className String?

    Grade   Grade[]
    Absence Absence[]

    @@id([id, userId])
}

model SchoolYear {
    id        String    @id @default(uuid())
    startDate DateTime
    endDate   DateTime
    Grade     Grade[]
    Absence   Absence[]
}

model Grade {
    id String @id @default(uuid())

    value       Int
    type        GradeType
    description String?

    student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
    studentId String

    schoolYear   SchoolYear @relation(fields: [schoolYearId], references: [id], onDelete: Cascade)
    schoolYearId String
}

enum GradeType {
    ORAL
    WRITTEN
    OTHER
}

model SchoolHour {
    num       Int      @id
    startTime DateTime @unique
    endTime   DateTime @unique
    Lesson    Lesson[]
}

model Classroom {
    name   String        @id
    type   ClassroomType @default(NORMAL)
    Lesson Lesson[]
}

enum ClassroomType {
    NORMAL
    LAB
    GYM
    COMPUTER
}

model Lesson {
    id String @id @default(uuid())

    description String?
    date        DateTime
    type        LessonType @default(NORMAL)

    employee_Subject    Employee_Subject @relation(fields: [employeeId, subjectAbbreviation], references: [employeeId, subjectAbbreviation], onDelete: Cascade)
    employeeId          String
    subjectAbbreviation String

    class     Class  @relation(fields: [className], references: [name], onDelete: Cascade)
    className String

    classroom     Classroom @relation(fields: [classroomName], references: [name], onDelete: Cascade)
    classroomName String

    schoolHour    SchoolHour @relation(fields: [schoolHourNum], references: [num], onDelete: Cascade)
    schoolHourNum Int

    Absence Absence[]
}

enum LessonType {
    NORMAL
    SUBSTITUTE
    GRADING
}

model Absence {
    id String @id @default(uuid())

    description String?

    lesson   Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)
    lessonId String

    student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
    studentId String

    schoolYear   SchoolYear @relation(fields: [schoolYearId], references: [id], onDelete: Cascade)
    schoolYearId String
}
